# Dazzle

Приложение для импорта накладных поставщиков в базу `shop.db` (Tirika Shop) с предпросмотром, ручной корректировкой и безопасной записью.

## Что умеет
- Загружает накладные:
  - Микадо (`.xls`, внутри HTML)
  - Аквилон (`.xls`, включая поврежденные файлы через Excel COM fallback)
- Автосопоставляет товар по:
  - `goods.product_code`
  - `cross_codes.cross_code`
  - `barcodes.barcode`
- Позволяет вручную выбрать товар для строки через визуальный поиск.
- Поддерживает действия по строке: `import` / `create` / `skip`.
- Автоматически считает новую продажную цену: `закупка +50%`, округление вверх до шага `50`.
- Показывает цену продажи из БД, сравнивает с новой и подсвечивает крупные расхождения.
- Импортирует в таблицы Tirika:
  - `waybills`
  - `waybill_items`
  - `payments` (если включена оплата)
  - `remainders` (увеличение остатков)
- Делает backup базы перед импортом (опционально).
- Имеет режим `dry-run` (проверка без записи, транзакция откатывается).
- Поддерживает проверку обновлений приложения через `latest.json` (GitHub/HTTP).

## Важные требования
- Windows + установленный Microsoft Excel (для fallback чтения проблемных `.xls`).
- Права записи к файлу `shop.db`.  
  Если база лежит в `C:\Program Files (x86)\...`, может понадобиться запуск от администратора.
- Приложение всегда запускается с UAC-повышением (запрос прав администратора при старте).

## Запуск
1. Установить зависимости:
```powershell
python -m pip install -r requirements.txt
```
2. Запустить приложение:
```powershell
python main.py
```

## Настройки (внутри приложения)
- Кнопка `Настройки` в верхней панели.
- Сохраняются:
  - путь к `shop.db`
  - папка с накладными
  - наценка
  - шаг округления
  - порог красной подсветки расхождения цены
- После этого в главном окне накладные выбираются из внутреннего списка файлов `.xls/.xlsx` без системного окна выбора.

## Сборка EXE
В корне проекта:

```powershell
.\build_exe.ps1
```

Или двойной клик по `build_exe.bat`.

Готовый файл:

`dist\Dazzle\Dazzle.exe`

Важно: это `one-folder` сборка. Для ручного переноса на другой ПК нужно копировать всю папку  
`dist\Dazzle` целиком, включая `_internal`.

## Сборка установщика (Setup.exe)
1. Установить Inno Setup 6 (чтобы был доступен `ISCC.exe`).
2. В корне проекта выполнить:

```powershell
.\build_installer.ps1
```

Или двойной клик по `build_installer.bat`.

По умолчанию версия установщика: `1.0.0`.  
Можно задать свою:

```powershell
.\build_installer.ps1 -AppVersion 1.0.1
```

По умолчанию используется уже готовый `dist\Dazzle\Dazzle.exe`.  
Если нужно сначала пересобрать EXE, добавьте флаг:

```powershell
.\build_installer.ps1 -RebuildExe
```

Готовый установщик появится в:

`installer_output\Dazzle-Setup-<version>.exe`

## Обновления через Git (GitHub Releases)
В приложении реализован автоапдейтер по манифесту `latest.json`.

### 1. Подготовить репозиторий
1. Создайте/используйте GitHub-репозиторий проекта.
2. Добавьте в репозиторий файл `updates/latest.json` (шаблон уже есть в проекте).

### 2. Выпустить новую версию
1. Обновите версию приложения в `tirika_importer/version.py` (`APP_VERSION`).
2. Соберите новый инсталлятор:
```powershell
.\build_installer.ps1 -RebuildExe -AppVersion 1.0.3
```
3. Возьмите SHA256 файла:
```powershell
Get-FileHash .\installer_output\Dazzle-Setup-1.0.3.exe -Algorithm SHA256
```
4. Создайте git tag и релиз на GitHub: `v1.0.3`.
5. Прикрепите в Release файл `Dazzle-Setup-1.0.3.exe`.
6. Обновите `updates/latest.json`:
```json
{
  "version": "1.0.3",
  "url": "https://github.com/ahiokk/Dazzle/releases/download/v1.0.3/Dazzle-Setup-1.0.3.exe",
  "sha256": "<SHA256>",
  "notes": "Краткое описание изменений"
}
```
7. Закоммитьте и запушьте `updates/latest.json` в `main`.

### 3. Настроить приложение Dazzle у пользователей
В `Настройки -> Обновления`:
1. Вставьте URL манифеста, например:
`https://raw.githubusercontent.com/<owner>/<repo>/main/updates/latest.json`
`https://raw.githubusercontent.com/ahiokk/Dazzle/main/updates/latest.json`
2. Включите `Проверять обновления при запуске`.

### 4. Как это работает
1. Dazzle сравнивает текущую версию и `version` из `latest.json`.
2. Если есть новая версия, показывает окно обновления.
3. По кнопке `Скачать и установить` скачивает setup, проверяет SHA256 и запускает тихую установку.

## Автозапуск Windows
- В приложении есть кнопка в верхней панели:
  - `Добавить в автозапуск`
  - `Убрать из автозапуска`
- В установщике есть отдельная галочка `Запускать вместе с Windows`.
- Для `.exe` автозапуск будет запускать сам `.exe`.
- Если запуск из исходников (`python main.py`), автозапуск создается через `pythonw.exe`.

## Поток работы
1. Открыть путь к `shop.db`.
2. Загрузить накладную.
3. Нажать `Автосопоставление`.
4. Проверить строки, при необходимости:
   - исправить `Good ID` вручную
   - выбрать товар через `Выбрать товар вручную`
   - поменять действие строки (`import/create/skip`)
5. Нажать `Проверка (dry-run)`.
6. Если всё корректно, нажать `Импорт в базу`.

## Примечание по данным
База Tirika в этом проекте содержит текст в кодировке `cp1251`; импорт учитывает это, чтобы не ломать отображение в Tirika.
